services:
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
    image: us-cycle-topics:latest
    container_name: us-cycle-topics-migrate
    command: ["npm", "run", "bootstrap"]
    environment:
      NODE_ENV: production
      SQLITE_DB_PATH: /data/us-cycle-topics.db
      STATIC_PUBLIC_DIR: /app/static-public
      SITE_BASE_URL: http://localhost:3000
      PREFLIGHT_ON_RUN: "true"
    volumes:
      - sqlite_data:/data
    restart: "no"

  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: us-cycle-topics:latest
    container_name: us-cycle-topics-web
    restart: unless-stopped
    init: true
    depends_on:
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      PORT: 3000
      SQLITE_DB_PATH: /data/us-cycle-topics.db
      STATIC_PUBLIC_DIR: /app/static-public
      SITE_BASE_URL: http://localhost:3000
      PREFLIGHT_ON_RUN: "true"
      SCHEDULER_CRON: "0 * * * *"
    ports:
      - "3000:3000"
    volumes:
      - sqlite_data:/data

  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    image: us-cycle-topics:latest
    container_name: us-cycle-topics-scheduler
    restart: unless-stopped
    init: true
    command: ["npm", "run", "scheduler"]
    depends_on:
      migrate:
        condition: service_completed_successfully
      web:
        condition: service_started
    environment:
      NODE_ENV: production
      SQLITE_DB_PATH: /data/us-cycle-topics.db
      STATIC_PUBLIC_DIR: /app/static-public
      SITE_BASE_URL: http://localhost:3000
      PREFLIGHT_ON_RUN: "true"
      SCHEDULER_CRON: "0 * * * *"
    volumes:
      - sqlite_data:/data

volumes:
  sqlite_data:
